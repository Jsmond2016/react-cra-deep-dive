# build.js 文件功能文档

## 1. 环境初始化
- **设置生产环境变量**：
  - `BABEL_ENV=production`
  - `NODE_ENV=production`
- **错误处理**：将未处理的Promise拒绝转换为错误抛出
- **加载环境配置**：通过 `require('../config/env')` 加载生产环境变量

## 2. 构建前准备
- **必需文件检查**：验证 `public/index.html` 和 `src/index.js` 是否存在
- **浏览器兼容性检查**：验证项目配置的浏览器支持
- **参数解析**：支持 `--stats` 参数生成构建统计文件

## 3. 构建流程

### 3.1 清理与准备
- **清空构建目录**：`fs.emptyDirSync(paths.appBuild)` 清空 build 文件夹
- **复制公共资源**：将 `public/` 文件夹内容复制到 `build/`（排除 index.html）

### 3.2 Webpack 构建
- **配置获取**：`configFactory('production')` 获取生产环境 webpack 配置
- **编译执行**：使用 webpack 进行生产环境构建
- **错误处理**：
  - 格式化 webpack 错误信息
  - 支持 TypeScript 错误继续构建 (`TSC_COMPILE_ON_ERROR=true`)
  - CI 环境下将警告视为错误

### 3.3 构建结果处理
- **文件大小分析**：
  - 构建前测量文件大小
  - 构建后显示 gzip 压缩后的文件大小
  - 警告阈值：bundle > 512KB, chunk > 1MB
- **统计文件生成**：可选生成 `bundle-stats.json` 构建统计文件

## 4. 输出与部署指导
- **构建结果展示**：
  - 成功/失败状态提示
  - 文件大小对比
  - 警告信息展示
- **部署指导**：通过 `printHostingInstructions` 提供部署说明

## 5. 关键配置

### 5.1 文件大小警告
- **Bundle 警告阈值**：512KB (gzip后)
- **Chunk 警告阈值**：1MB (gzip后)

### 5.2 环境变量
- `TSC_COMPILE_ON_ERROR=true`：TypeScript 错误时继续构建
- `CI=true`：CI 模式下警告视为错误
- `--stats` 参数：生成构建统计文件

## 6. 使用方式
```bash
npm run build              # 基本构建
npm run build -- --stats   # 生成构建统计文件
TSC_COMPILE_ON_ERROR=true npm run build  # 忽略TypeScript错误
```

该文件负责 Create React App 的生产环境构建，从环境准备到最终部署指导的完整流程。